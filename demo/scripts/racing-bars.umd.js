!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],e):e((t=t||self).racingBars={},t.d3)}(this,function(t,e){function n(){return(n=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function r(t,e){for(;t.toString().length<e;)t="0"+t;return t}function a(t,e,n){var r;if(n)if(String(n).startsWith("window")){var a=+n.split("*")[1]||1;r=window.innerHeight*a}else r=+n;else r=t.getBoundingClientRect().height;return r>e?r:e}function i(t,e,n){var r;if(n)if(String(n).startsWith("window")){var a=+n.split("*")[1]||1;r=window.innerWidth*a}else r=+n;else r=t.getBoundingClientRect().width;return r>e?r:e}function o(t){var e=new Set;return t.forEach(function(t){e.add(t.date)}),Array.from(e).sort()}function u(t){var e=new Date(t);if(isNaN(+e))throw new Error('"'+t+'" is not a valid date');var n=e.getFullYear(),a=(1+e.getMonth()).toString();return""+n+(a=r(a,2))+r(e.getDate().toString(),2)}function s(t,e){var n=t.slice(0,4),r=t.slice(4,6),a=t.slice(6,8),i=new Date(n+"-"+r+"-"+a).getDay();return e.replace("MMM",{"01":"Jan","02":"Feb","03":"Mar","04":"Apr","05":"May","06":"Jun","07":"Jul","08":"Aug","09":"Sep",10:"Oct",11:"Nov",12:"Dec"}[r]).replace("DDD",{0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"}[i]).replace("YYYY",n).replace("MM",r).replace("DD",a)}var l,c,d,f,h,p,v,g,y,w,m,x,b,k,D,L,M;function Y(t,e,n,r,a,i){k=e,D=n,L=r,M=i;var o,u=0,s=t.length-1,l=t[s];function c(){a(o=t[u])}return x={inc:function(t){void 0===t&&(t=1);var e=u+t;u=e>s?s:e,c()},dec:function(t){void 0===t&&(t=1);var e=u-t;u=e<0?0:e,c()},setFirst:function(){u=0,c()},setLast:function(){u=t.length-1,c()},update:function(){c()},set:function(e){var n=t.indexOf(e);n>-1&&(u=n,c())},getDate:function(){return o},isLast:function(){return o===l},getDates:function(){return[].concat(t)},isRunning:function(){return b},setRunning:function(t){return W(t)}}}function C(){W(!0),m=e.interval(function(t){x.isLast()?(M(),D?F():E()):x.inc()},k)}function E(){m.stop(),W(!1)}function S(){E(),x.setFirst(),M()}function F(){x.setFirst(),M()}function N(){E(),x.setLast(),M()}function T(){x.isLast()?(S(),C()):b?E():C()}function W(t){void 0===t&&(t=!0);var e=document.querySelector(L+" .play"),n=document.querySelector(L+" .pause");t?(b=!0,e.style.display="none",n.style.display="unset"):(b=!1,e.style.display="unset",n.style.display="none")}t.loadData=function(t,e){switch(void 0===e&&(e="json"),e){case"json":return d3.json(t);case"csv":return d3.csv(t);case"tsv":return d3.tsv(t);case"xml":return d3.xml(t);default:throw new Error("Unsupported data type: "+e)}},t.race=function(t,m){void 0===m&&(m={});var x,b=m.dataShape||"long",k=m.fillDateGaps,D=m.selector||"#race",L=m.startDate?u(m.startDate):"",M=m.endDate?u(m.endDate):"",W=m.loop||!1,A=m.colorSeed||"",B=m.disableGroupColors||!1,j=Number(m.tickDuration)||500,H=Number(m.topN)||10,O=m.disableClickEvents||!0,R=m.disableKeyboardEvents,q=!1!==m.autorun,V={title:m.title||"18 years of Top Global Brands",subTitle:m.subTitle||"Brand value, $m",caption:m.caption||"Source: Interbrand",dateCounterFormat:m.dateCounterFormat||"YYYY",labelsOnBars:!1!==m.labelsOnBars,labelsWidth:m.labelsWidth||100,showControls:m.showControls||"all",inputHeight:m.height,inputWidth:m.width,minHeight:300,minWidth:500,tickDuration:j,topN:H},G=document.querySelector(D);t=function(t,e,a,i){var o;return"wide"===e&&(o=[],t.forEach(function(t){for(var e=0,n=Object.entries(t);e<n.length;e++){var r=n[e];o.push({date:t.date,name:r[0],value:Number(r[1])})}}),t=o),t.map(function(t){var e=n({},t);return e.value=isNaN(+e.value)?0:+e.value,e.date=u(e.date),e.color=function(t,e,n){return d3.hsl(360*function(t){var e=function(t){for(var e="",n=0;n<t.length;n++)e+=r(String(t.charCodeAt(n)),3);return e}(t),n=1e4*Math.sin(+e);return n-Math.floor(n)}((t.group&&!e?t.group:t.name)+n),.75,.75)}(e,a,i),e})}(t=function(t,e,n){return t.filter(function(t){return!e||t.date>=e}).filter(function(t){return!n||t.date<=n})}(t,L,M),b,B,A),k&&(t=function(t,e,r){var a=new Date(s(e[0],"YYYY-MM-DD")),i=new Date(s(e[e.length-1],"YYYY-MM-DD")),o={years:function(t){t.setFullYear(t.getFullYear()+1)},months:function(t){t.setMonth(t.getMonth()+1)},days:function(t){t.setDate(t.getDate()+1)}};if(!o[r])return t;for(var l=[],c=a;c<i;o[r](c))l.push(u(c));return l.forEach(function(e,r){if(!(t.filter(function(t){return t.date===e}).length>0)){var a=t.filter(function(t){return t.date===l[r-1]}).map(function(t){return n(n({},t),{},{date:e})});t.push.apply(t,a)}}),t}(t,o(t),k));var J,z=Y(o(t),j,W,D,function(e){J=function(t,e,r,a){var i=t.filter(function(t){return t.date===e&&!isNaN(t.value)}).map(function(t){if(!r)return t;var e=r[t.name].value;return r[t.name].date=t.date,r[t.name].value=t.value,n(n({},t),{},{lastValue:e})}).sort(function(t,e){return e.value-t.value}).slice(0,a);return i.forEach(function(t,e){return t.rank=e}),i}(t,z.getDate(),x,H),K(),G.dispatchEvent(new CustomEvent("dateChanged",{detail:{date:s(e,"YYYY-MM-DD")}}))},K);function I(){!function(t,n,r,o,u,m){var x=r.inputHeight,b=r.inputWidth,k=r.minHeight,D=r.minWidth,L=r.labelsOnBars,M=r.labelsWidth,Y=r.topN,C=r.title,E=r.subTitle,S=r.caption,F=r.dateCounterFormat,N=r.showControls,T=document.querySelector(t);y=a(T,k,x),w=i(T,D,b),c=e.select(t).append("svg").attr("width",w).attr("height",y),p=(y-((l={top:80,right:0,bottom:5,left:0+(L?0:M)}).bottom+l.top))/(5*Y),c.append("text").attr("class","title").attr("y",24).html(C),c.append("text").attr("class","subTitle").attr("y",55).html(E),d=e.scaleLinear().domain([0,e.max(n,function(t){return t.value})]).range([l.left,w-l.right-65]),f=e.scaleLinear().domain([Y,0]).range([y-l.bottom,l.top]),h=e.axisTop(d).ticks(w>500?5:2).tickSize(-(y-l.top-l.bottom)).tickFormat(function(t){return e.format(",")(t)}),c.append("g").attr("class","axis xAxis").attr("transform","translate(0, "+l.top+")").call(h).selectAll(".tick line").classed("origin",function(t){return 0===t}),c.selectAll("rect.bar").data(n,function(t){return t.name}).enter().append("rect").attr("class","bar").attr("x",d(0)+1).attr("width",function(t){return Math.abs(d(t.value)-d(0)-1)}).attr("y",function(t){return f(t.rank)+5}).attr("height",f(1)-f(0)-p).style("fill",function(t){return t.color}),g=L?function(t){return d(t.value)-8}:l.left-8,c.selectAll("text.label").data(n,function(t){return t.name}).enter().append("text").attr("class","label").attr("x",g).attr("y",function(t){return f(t.rank)+5+(f(1)-f(0))/2+1}).style("text-anchor","end").html(function(t){return t.name}),c.selectAll("text.valueLabel").data(n,function(t){return t.name}).enter().append("text").attr("class","valueLabel").attr("x",function(t){return d(t.value)+5}).attr("y",function(t){return f(t.rank)+5+(f(1)-f(0))/2+1}).text(function(t){return e.format(",.0f")(t.lastValue)}),v=c.append("text").attr("class","dateCounterText").attr("x",w-l.right-p).attr("y",y-40).style("text-anchor","end").html(s(o(),F)).call(function(t,e){t.select(function(){return this.parentNode.insertBefore(this.cloneNode(!0),this)}).style("fill","#ffffff").style("stroke","#ffffff").style("stroke-width",e).style("stroke-linejoin","round").style("opacity",1)},10),c.append("text").attr("class","caption").attr("x",w-l.right-p-10).attr("y",y-l.bottom-p).style("text-anchor","end").html(S),function(t,e,n){t.style.position="relative";var r=o("div","controls","",t);r.style.position="absolute",r.style.top="0",r.style.right=l.right+p+"px";var a=o("div","rewind",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-skip-back"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',r);a.addEventListener("click",n.rewindTicker),o("div","play",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',r).addEventListener("click",n.toggle),o("div","pause",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',r).addEventListener("click",n.toggle);var i=o("div","fastforward",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-skip-forward"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',r);switch(i.addEventListener("click",n.fastForwardTicker),e){case"play":a.style.visibility="hidden",i.style.visibility="hidden";break;case"none":r.style.display="none"}function o(t,e,n,r){var a=document.createElement(t);return a.classList.add(e),a.innerHTML=n,r.appendChild(a),a}}(T,N,u),m(!1)}(D,J,V,z.getDate,{rewindTicker:S,toggle:T,fastForwardTicker:N},z.setRunning)}function K(){!function(t,n,r){if(d){var a=n.tickDuration,i=n.topN,o=n.dateCounterFormat;d.domain([0,e.max(t,function(t){return t.value})]),c.select(".xAxis").transition().duration(a).ease(e.easeLinear).call(h);var u=c.selectAll(".bar").data(t,function(t){return t.name});u.enter().append("rect").attr("class",function(t){return"bar "+t.name.replace(/\s/g,"_")}).attr("x",d(0)+1).attr("width",function(t){return Math.abs(d(t.value)-d(0)-1)}).attr("y",function(){return f(i+1)+5}).attr("height",f(1)-f(0)-p).style("fill",function(t){return t.color}).transition().duration(a).ease(e.easeLinear).attr("y",function(t){return f(t.rank)+5}),u.transition().duration(a).ease(e.easeLinear).attr("width",function(t){return Math.abs(d(t.value)-d(0)-1)}).attr("y",function(t){return f(t.rank)+5}),u.exit().transition().duration(a).ease(e.easeLinear).attr("width",function(t){return Math.abs(d(t.value)-d(0)-1)}).attr("y",function(){return f(i+1)+5}).remove();var l=c.selectAll(".label").data(t,function(t){return t.name});l.enter().append("text").attr("class","label").attr("x",g).attr("y",function(){return f(i+1)+5+(f(1)-f(0))/2}).style("text-anchor","end").html(function(t){return t.name}).transition().duration(a).ease(e.easeLinear).attr("y",function(t){return f(t.rank)+5+(f(1)-f(0))/2+1}),l.transition().duration(a).ease(e.easeLinear).attr("x",g).attr("y",function(t){return f(t.rank)+5+(f(1)-f(0))/2+1}),l.exit().transition().duration(a).ease(e.easeLinear).attr("x",g).attr("y",function(){return f(i+1)+5}).remove();var y=c.selectAll(".valueLabel").data(t,function(t){return t.name});y.enter().append("text").attr("class","valueLabel").attr("x",function(t){return d(t.value)+5}).attr("y",function(){return f(i+1)+5}).text(function(t){return e.format(",.0f")(t.lastValue)}).transition().duration(a).ease(e.easeLinear).attr("y",function(t){return f(t.rank)+5+(f(1)-f(0))/2+1}),y.transition().duration(a).ease(e.easeLinear).attr("x",function(t){return d(t.value)+5}).attr("y",function(t){return f(t.rank)+5+(f(1)-f(0))/2+1}).tween("text",function(t){var n=e.interpolateRound(t.lastValue,t.value);return function(t){this.textContent=e.format(",")(n(t))}}),y.exit().transition().duration(a).ease(e.easeLinear).attr("x",function(t){return d(t.value)+5}).attr("y",function(){return f(i+1)+5}).remove(),v.html(s(r(),o))}}(J,V,z.getDate)}return x={},t.forEach(function(t){t.lastValue=t.value,(!x[t.name]||t.date<x[t.name].date)&&(x[t.name]={date:t.date,value:t.value})}),z.setFirst(),I(),K(),C(),q||E(),O||(G.querySelector("svg").addEventListener("click",T),G.addEventListener("dblclick",N)),R||document.addEventListener("keypress",function(t){switch(t.keyCode){case 32:T();break;case 97:S();break;case 115:T();break;case 100:N()}}),window.addEventListener("resize",function(){!function(t,e,n){if(!e.height&&!e.width||String(e.height).startsWith("window")||String(e.width).startsWith("window")){y=a(t,e.minHeight,e.height),w=i(t,e.minWidth,e.width);var r=t.style.position;n(),t.style.position=r}}(G,V,function(){var t=z.isRunning();E(),G.innerHTML="",z.update(),I(),t&&C()})}),{start:function(){z.isRunning()||C()},stop:function(){E()},rewind:function(){S()},fastforward:function(){N()},loop:function(){F()},inc:function(t){void 0===t&&(t=1),z.inc(t)},dec:function(t){void 0===t&&(t=1),z.dec(t)},getCurrentDate:function(){return z.getDate()},getDates:function(){return z.getDates().map(function(t){return s(t,"YYYY-MM-DD")})},setDate:function(t){z.set(u(t))},createScroller:function(){!function(){!function(){G.style.position="fixed",G.style.top="0";var t=document.createElement("div");t.style.height=10*window.innerHeight+"px",document.body.appendChild(t)}();var t=z.getDates(),e=document.body.clientHeight/t.length;window.addEventListener("scroll",function(){var n=Math.ceil(window.pageYOffset/e);n<t.length?z.set(t[n]):z.setLast()})}()}}}});
//# sourceMappingURL=racing-bars.umd.js.map
