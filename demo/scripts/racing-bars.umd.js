!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],e):e((t=t||self).racingBars={},t.d3)}(this,function(t,e){function n(){return(n=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function r(t,e){for(;t.toString().length<e;)t="0"+t;return t}function a(t,e,n){var r;if(n)if(String(n).startsWith("window")){var a=+n.split("*")[1]||1;r=window.innerHeight*a}else r=+n;else r=t.getBoundingClientRect().height;return r>e?r:e}function i(t,e,n){var r;if(n)if(String(n).startsWith("window")){var a=+n.split("*")[1]||1;r=window.innerWidth*a}else r=+n;else r=t.getBoundingClientRect().width;return r>e?r:e}function o(t){var e=new Date(t);if(isNaN(+e))throw new Error('"'+t+'" is not a valid date');var n=e.getFullYear(),a=(1+e.getMonth()).toString();return""+n+(a=r(a,2))+r(e.getDate().toString(),2)}function u(t,e){var n=t.slice(0,4),r=t.slice(4,6),a=t.slice(6,8),i=new Date(n+"-"+r+"-"+a).getDay();return e.replace("MMM",{"01":"Jan","02":"Feb","03":"Mar","04":"Apr","05":"May","06":"Jun","07":"Jul","08":"Aug","09":"Sep",10:"Oct",11:"Nov",12:"Dec"}[r]).replace("DDD",{0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"}[i]).replace("YYYY",n).replace("MM",r).replace("DD",a)}t.loadData=function(t,e){switch(void 0===e&&(e="json"),e){case"json":return d3.json(t);case"csv":return d3.csv(t);case"tsv":return d3.tsv(t);case"xml":return d3.xml(t);default:throw new Error("Unsupported data type: "+e)}},t.race=function(t,s){void 0===s&&(s={});var l,c=s.dataShape||"long",d=s.fillDateGaps,f=s.selector||"#race",p=s.startDate?o(s.startDate):"",h=s.endDate?o(s.endDate):"",v=s.colorSeed||"",g=s.disableGroupColors||!1,y=Number(s.tickDuration)||500,w=Number(s.topN)||10,m=s.disableClickEvents||!0,x=s.disableKeyboardEvents,b=!1!==s.autorun,k={loop:s.loop||!1,tickDuration:y},D=function(t,r){var o,s,l,c,d,f,p,h,v,g,y;return{renderInitalView:function(t){var n=r.selector,w=r.title,m=r.subTitle,x=r.caption,b=r.dateCounterFormat,k=r.labelsOnBars,D=r.labelsWidth,L=r.showControls,M=r.inputHeight,Y=r.inputWidth,C=r.minHeight,F=r.minWidth,E=r.topN,S=t.length>0?t[0].date:"",W=document.querySelector(n);v=a(W,C,M),g=i(W,F,Y),s=e.select(n).append("svg").attr("width",g).attr("height",v),f=(v-((o={top:80,right:0,bottom:5,left:0+(k?0:D)}).bottom+o.top))/(5*E),s.append("text").attr("class","title").attr("y",24).html(w),s.append("text").attr("class","subTitle").attr("y",55).html(m),l=e.scaleLinear().domain([0,e.max(t,function(t){return t.value})]).range([o.left,g-o.right-65]),c=e.scaleLinear().domain([E,0]).range([v-o.bottom,o.top]),d=e.axisTop(l).ticks(g>500?5:2).tickSize(-(v-o.top-o.bottom)).tickFormat(function(t){return e.format(",")(t)}),s.append("g").attr("class","axis xAxis").attr("transform","translate(0, "+o.top+")").call(d).selectAll(".tick line").classed("origin",function(t){return 0===t}),s.selectAll("rect.bar").data(t,function(t){return t.name}).enter().append("rect").attr("class","bar").attr("x",l(0)+1).attr("width",function(t){return Math.abs(l(t.value)-l(0)-1)}).attr("y",function(t){return c(t.rank)+5}).attr("height",c(1)-c(0)-f).style("fill",function(t){return t.color}),h=k?function(t){return l(t.value)-8}:o.left-8,s.selectAll("text.label").data(t,function(t){return t.name}).enter().append("text").attr("class","label").attr("x",h).attr("y",function(t){return c(t.rank)+5+(c(1)-c(0))/2+1}).style("text-anchor","end").html(function(t){return t.name}),s.selectAll("text.valueLabel").data(t,function(t){return t.name}).enter().append("text").attr("class","valueLabel").attr("x",function(t){return l(t.value)+5}).attr("y",function(t){return c(t.rank)+5+(c(1)-c(0))/2+1}).text(function(t){return e.format(",.0f")(t.lastValue)}),p=s.append("text").attr("class","dateCounterText").attr("x",g-o.right-f).attr("y",v-40).style("text-anchor","end").html(u(S,b)).call(function(t,e){t.select(function(){return this.parentNode.insertBefore(this.cloneNode(!0),this)}).style("fill","#ffffff").style("stroke","#ffffff").style("stroke-width",e).style("stroke-linejoin","round").style("opacity",1)},10),s.append("text").attr("class","caption").attr("x",g-o.right-f-10).attr("y",v-o.bottom-f).style("text-anchor","end").html(x),function(t,e){t.style.position="relative";var n=s("div","controls","",t);n.style.position="absolute",n.style.top="0",n.style.right=o.right+f+"px";var r=s("div","rewind",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-skip-back"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',n),a=s("div","play",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',n),i=s("div","pause",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',n),u=s("div","fastforward",'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-skip-forward"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',n);switch(y={rewind:r,play:a,pause:i,fastforward:u},e){case"play":r.style.visibility="hidden",u.style.visibility="hidden";break;case"none":n.style.display="none"}function s(t,e,n,r){var a=document.createElement(t);return a.classList.add(e),a.innerHTML=n,r.appendChild(a),a}}(W,L)},renderFrame:function(t){if(l){var n=r.tickDuration,a=r.topN,i=r.dateCounterFormat,o=t.length>0?t[0].date:"";l.domain([0,e.max(t,function(t){return t.value})]),s.select(".xAxis").transition().duration(n).ease(e.easeLinear).call(d);var v=s.selectAll(".bar").data(t,function(t){return t.name});v.enter().append("rect").attr("class",function(t){return"bar "+t.name.replace(/\s/g,"_")}).attr("x",l(0)+1).attr("width",function(t){return Math.abs(l(t.value)-l(0)-1)}).attr("y",function(){return c(a+1)+5}).attr("height",c(1)-c(0)-f).style("fill",function(t){return t.color}).transition().duration(n).ease(e.easeLinear).attr("y",function(t){return c(t.rank)+5}),v.transition().duration(n).ease(e.easeLinear).attr("width",function(t){return Math.abs(l(t.value)-l(0)-1)}).attr("y",function(t){return c(t.rank)+5}),v.exit().transition().duration(n).ease(e.easeLinear).attr("width",function(t){return Math.abs(l(t.value)-l(0)-1)}).attr("y",function(){return c(a+1)+5}).remove();var g=s.selectAll(".label").data(t,function(t){return t.name});g.enter().append("text").attr("class","label").attr("x",h).attr("y",function(){return c(a+1)+5+(c(1)-c(0))/2}).style("text-anchor","end").html(function(t){return t.name}).transition().duration(n).ease(e.easeLinear).attr("y",function(t){return c(t.rank)+5+(c(1)-c(0))/2+1}),g.transition().duration(n).ease(e.easeLinear).attr("x",h).attr("y",function(t){return c(t.rank)+5+(c(1)-c(0))/2+1}),g.exit().transition().duration(n).ease(e.easeLinear).attr("x",h).attr("y",function(){return c(a+1)+5}).remove();var y=s.selectAll(".valueLabel").data(t,function(t){return t.name});y.enter().append("text").attr("class","valueLabel").attr("x",function(t){return l(t.value)+5}).attr("y",function(){return c(a+1)+5}).text(function(t){return e.format(",.0f")(t.lastValue)}).transition().duration(n).ease(e.easeLinear).attr("y",function(t){return c(t.rank)+5+(c(1)-c(0))/2+1}),y.transition().duration(n).ease(e.easeLinear).attr("x",function(t){return l(t.value)+5}).attr("y",function(t){return c(t.rank)+5+(c(1)-c(0))/2+1}).tween("text",function(t){var n=e.interpolateRound(t.lastValue,t.value);return function(t){this.textContent=e.format(",")(n(t))}}),y.exit().transition().duration(n).ease(e.easeLinear).attr("x",function(t){return l(t.value)+5}).attr("y",function(){return c(a+1)+5}).remove(),p.html(u(o,i))}},resize:function(e){if(!r.inputHeight&&!r.inputWidth||String(r.inputHeight).startsWith("window")||String(r.inputWidth).startsWith("window")){var n=document.querySelector(t);v=a(n,r.minHeight,r.inputHeight),g=i(n,r.minWidth,r.inputWidth);var o=n.style.position;e(),n.style.position=o}},renderAsRunning:function(t){t?(y.play.style.display="none",y.pause.style.display="unset"):(y.play.style.display="unset",y.pause.style.display="none")},getRenderedHeight:function(){return v},getRenderedWidth:function(){return g},getControlButtons:function(){return n({},y)}}}(f,{selector:f,title:s.title||"18 years of Top Global Brands",subTitle:s.subTitle||"Brand value, $m",caption:s.caption||"Source: Interbrand",dateCounterFormat:s.dateCounterFormat||"YYYY",labelsOnBars:!1!==s.labelsOnBars,labelsWidth:s.labelsWidth||100,showControls:s.showControls||"all",inputHeight:s.height,inputWidth:s.width,minHeight:300,minWidth:500,tickDuration:y,topN:w}),L=function(t){var n,r,a,i,o,u;function s(){f(!0),n=e.interval(function(t){r.isLast()?(u(),o?d():l()):r.inc()},i)}function l(){n&&n.stop(),f(!1)}function c(){l(),r.setFirst(),u()}function d(){r.setFirst(),u()}function f(t){void 0===t&&(t=!0),function(t){D.renderAsRunning(t)}(a=t)}return{tickerDateFactory:function(t,e,n,a){i=e.tickDuration,o=e.loop,u=a;var s,l=0,c=t.length-1,d=t[c];function f(){n(s=t[l])}return r={inc:function(t){void 0===t&&(t=1);var e=l+t;l=e>c?c:e,f()},dec:function(t){void 0===t&&(t=1);var e=l-t;l=e<0?0:e,f()},setFirst:function(){l=0,f()},setLast:function(){l=t.length-1,f()},update:function(){f()},getDate:function(){return s},setDate:function(e){var n=t.indexOf(e);n>-1&&(l=n,f())},isLast:function(){return s===d}}},start:s,stop:l,rewind:c,loop:d,fastForward:function(){l(),r.setLast(),u()},toggle:function(){r.isLast()?(c(),s()):a?l():s()},isRunning:function(){return a}}}(),M=document.querySelector(f),Y=function(t){var e=new Set;return t.forEach(function(t){e.add(t.date)}),Array.from(e).sort()}(t=function(t,e,a,i){var u;return"wide"===e&&(u=[],t.forEach(function(t){for(var e=0,n=Object.entries(t);e<n.length;e++){var r=n[e];u.push({date:t.date,name:r[0],value:Number(r[1])})}}),t=u),t.map(function(t){var e=n({},t);return e.value=isNaN(+e.value)?0:+e.value,e.date=o(e.date),e.color=function(t,e,n){return d3.hsl(360*(a=function(t){for(var e="",n=0;n<t.length;n++)e+=r(String(t.charCodeAt(n)),3);return e}((t.group&&!e?t.group:t.name)+n),(i=1e4*Math.sin(+a))-Math.floor(i)),.75,.75);var a,i}(e,a,i),e})}(t=function(t,e,n){return t.filter(function(t){return!e||t.date>=e}).filter(function(t){return!n||t.date<=n})}(t,p,h),c,g,v));d&&(t=function(t,e,r){var a=new Date(u(e[0],"YYYY-MM-DD")),i=new Date(u(e[e.length-1],"YYYY-MM-DD")),s={years:function(t){t.setFullYear(t.getFullYear()+1)},months:function(t){t.setMonth(t.getMonth()+1)},days:function(t){t.setDate(t.getDate()+1)}};if(!s[r])return t;for(var l=[],c=a;c<i;s[r](c))l.push(o(c));return l.forEach(function(e,r){if(!(t.filter(function(t){return t.date===e}).length>0)){var a=t.filter(function(t){return t.date===l[r-1]}).map(function(t){return n(n({},t),{},{date:e})});t.push.apply(t,a)}}),t}(t,Y,d));var C,F=L.tickerDateFactory(Y,k,function(e){C=function(t,e,r,a){return t.filter(function(t){return t.date===e&&!isNaN(t.value)}).map(function(t){if(!r[t.name])return t;var e=r[t.name].value;return r[t.name].date=t.date,r[t.name].value=t.value,n(n({},t),{},{lastValue:e})}).sort(function(t,e){return e.value-t.value}).slice(0,a).map(function(t,e){return n(n({},t),{},{rank:e})})}(t,F.getDate(),l,w),S(),M.dispatchEvent(new CustomEvent("dateChanged",{detail:{date:u(e,"YYYY-MM-DD")}}))},S);function E(){var t;D.renderInitalView(C),L.stop(),(t=D.getControlButtons())&&(t.rewind.addEventListener("click",L.rewind),t.play.addEventListener("click",L.toggle),t.pause.addEventListener("click",L.toggle),t.fastforward.addEventListener("click",L.fastForward))}function S(){D.renderFrame(C)}return l={},t.forEach(function(t){t.lastValue=t.value,(!l[t.name]||t.date<l[t.name].date)&&(l[t.name]={date:t.date,value:t.value})}),F.setFirst(),E(),S(),L.start(),b||L.stop(),m||(M.querySelector("svg").addEventListener("click",L.toggle),M.addEventListener("dblclick",L.fastForward)),x||document.addEventListener("keypress",function(t){switch(t.keyCode){case 32:L.toggle();break;case 97:L.rewind();break;case 115:L.toggle();break;case 100:L.fastForward()}}),window.addEventListener("resize",function(){D.resize(function(){var t=L.isRunning();L.stop(),M.innerHTML="",F.update(),E(),t&&L.start()})}),{start:function(){L.isRunning()||L.start()},stop:function(){L.stop()},rewind:function(){L.rewind()},fastforward:function(){L.fastForward()},loop:function(){L.loop()},inc:function(t){void 0===t&&(t=1),F.inc(t)},dec:function(t){void 0===t&&(t=1),F.dec(t)},getDate:function(){return F.getDate()},setDate:function(t){F.setDate(o(t))},getAllDates:function(){return Y.map(function(t){return u(t,"YYYY-MM-DD")})},createScroller:function(){!function(){!function(){M.style.position="fixed",M.style.top="0";var t=document.createElement("div");t.style.height=10*window.innerHeight+"px",document.body.appendChild(t)}();var t=document.body.clientHeight/Y.length;window.addEventListener("scroll",function(){var e=Math.ceil(window.pageYOffset/t);e<Y.length?F.setDate(Y[e]):F.setLast()})}()}}}});
//# sourceMappingURL=racing-bars.umd.js.map
